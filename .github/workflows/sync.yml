name: Sync with Parent

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Triggers:
#   1. Cron: Saatte bir upstream kontrolÃ¼
#   2. repository_dispatch: Parent push yaptÄ±ÄŸÄ±nda
#   3. workflow_dispatch: Manuel tetikleme
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  schedule:
    - cron: "0 * * * *"  # Her saat baÅŸÄ±

  repository_dispatch:
    types: [upstream-sync]

  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run â€” merge etme, sadece kontrol et"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

env:
  UPSTREAM_REPO: "https://github.com/Giorino/sync-parent.git"
  UPSTREAM_BRANCH: "main"
  TARGET_BRANCH: "main"

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    name: Sync upstream changes
    runs-on: ubuntu-latest

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1. Checkout â€” full history gerekli
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.SYNC_PAT }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2. Git identity ayarla
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # Remote URL'i PAT ile gÃ¼ncelle (workflow dosyalarÄ±nÄ± push edebilmek iÃ§in)
          git remote set-url origin "https://x-access-token:${{ secrets.SYNC_PAT }}@github.com/${{ github.repository }}.git"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3. Upstream remote ekle ve fetch et
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Add upstream remote
        run: |
          git remote add upstream "${{ env.UPSTREAM_REPO }}" 2>/dev/null || true
          git fetch upstream
          echo ""
          echo "ğŸ“Š Upstream status:"
          echo "  Local HEAD:    $(git rev-parse HEAD)"
          echo "  Upstream HEAD: $(git rev-parse upstream/${{ env.UPSTREAM_BRANCH }})"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4. DeÄŸiÅŸiklik var mÄ± kontrol et
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Check for changes
        id: check
        run: |
          LOCAL_SHA=$(git rev-parse HEAD)
          UPSTREAM_SHA=$(git rev-parse upstream/${{ env.UPSTREAM_BRANCH }})

          if [ "$LOCAL_SHA" = "$UPSTREAM_SHA" ]; then
            echo "âœ… Already up to date â€” nothing to sync."
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            BEHIND=$(git rev-list --count HEAD..upstream/${{ env.UPSTREAM_BRANCH }})
            if [ "$BEHIND" -eq 0 ]; then
              echo "âœ… Upstream has no new commits â€” nothing to sync."
              echo "has_changes=false" >> $GITHUB_OUTPUT
            else
              echo "ğŸ”„ $BEHIND commit(s) behind upstream."
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "behind_count=$BEHIND" >> $GITHUB_OUTPUT
            fi
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 5. Dry run modu (sadece kontrol)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Dry run check
        if: steps.check.outputs.has_changes == 'true' && github.event.inputs.dry_run == 'true'
        run: |
          echo "ğŸ§ª DRY RUN â€” Merge simÃ¼lasyonu:"
          if git merge --no-commit --no-ff --allow-unrelated-histories upstream/${{ env.UPSTREAM_BRANCH }} 2>/dev/null; then
            echo "  âœ… Clean merge mÃ¼mkÃ¼n"
            git merge --abort 2>/dev/null || true
          else
            echo "  âš ï¸  Conflict tespit edildi!"
            git merge --abort 2>/dev/null || true
            echo ""
            echo "Conflict'li dosyalar:"
            git diff --name-only --diff-filter=U 2>/dev/null || true
          fi
          echo ""
          echo "â„¹ï¸  Dry run tamamlandÄ± â€” deÄŸiÅŸiklik uygulanmadÄ±."

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 6. Sync branch oluÅŸtur ve merge dene
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create sync branch and attempt merge
        id: merge
        if: steps.check.outputs.has_changes == 'true' && github.event.inputs.dry_run != 'true'
        run: |
          TIMESTAMP=$(date -u +%Y%m%d-%H%M%S)
          BRANCH_NAME="upstream-sync-${TIMESTAMP}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          echo "ğŸŒ¿ Creating sync branch: $BRANCH_NAME"
          git checkout -b "$BRANCH_NAME"

          echo "ğŸ”€ Merging upstream/${{ env.UPSTREAM_BRANCH }}..."

          if git merge upstream/${{ env.UPSTREAM_BRANCH }} \
              --no-edit \
              --allow-unrelated-histories \
              -m "chore: sync with upstream ($(date -u +%Y-%m-%dT%H:%M:%SZ))"; then
            echo ""
            echo "âœ… Merge successful â€” no conflicts."
            echo "merge_status=clean" >> $GITHUB_OUTPUT
          else
            echo ""
            echo "âš ï¸ Merge has conflicts â€” committing conflict markers."
            echo "merge_status=conflict" >> $GITHUB_OUTPUT

            # Conflict'li dosyalarÄ± kaydet
            CONFLICTED_FILES=$(git diff --name-only --diff-filter=U | tr '\n' ',' | sed 's/,$//')
            echo "conflicted_files=$CONFLICTED_FILES" >> $GITHUB_OUTPUT
            echo "Conflicted files: $CONFLICTED_FILES"

            # Conflict marker'lÄ± dosyalarÄ± commit et
            git add -A
            git commit -m "chore: upstream sync conflict (needs manual resolution)

          Conflicted files: ${CONFLICTED_FILES}

          This branch contains merge conflicts from upstream that need
          manual resolution. Please resolve the conflicts and merge this PR."
          fi

          # Branch'i push et
          echo ""
          echo "ğŸš€ Pushing branch..."
          git push origin "$BRANCH_NAME"
          echo "âœ… Branch pushed."

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 7. Label'larÄ± oluÅŸtur (yoksa)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Ensure labels exist
        if: steps.merge.outputs.merge_status == 'clean' || steps.merge.outputs.merge_status == 'conflict'
        env:
          GH_TOKEN: ${{ secrets.SYNC_PAT }}
        run: |
          gh label create "auto-sync" \
            --description "Automatically created by upstream sync" \
            --color "0E8A16" 2>/dev/null || true

          gh label create "conflict" \
            --description "Merge conflict needs manual resolution" \
            --color "D93F0B" 2>/dev/null || true

          gh label create "ready-to-merge" \
            --description "Clean sync â€” ready to merge" \
            --color "0075CA" 2>/dev/null || true

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 8. Clean merge â†’ PR oluÅŸtur (review iÃ§in)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Wait for branch propagation
        if: steps.merge.outputs.merge_status == 'clean' || steps.merge.outputs.merge_status == 'conflict'
        run: |
          echo "â³ Waiting for GitHub to process the pushed branch..."
          sleep 5

      - name: Create clean sync PR
        if: steps.merge.outputs.merge_status == 'clean'
        env:
          GH_TOKEN: ${{ secrets.SYNC_PAT }}
        run: |
          BRANCH_NAME="${{ steps.merge.outputs.branch_name }}"
          BEHIND_COUNT="${{ steps.check.outputs.behind_count }}"

          PR_TITLE="âœ… Upstream Sync â€” ${BEHIND_COUNT} commit"
          PR_BODY="## âœ… Upstream Sync â€” Clean Merge\n\nUpstream deÄŸiÅŸiklikler baÅŸarÄ±yla merge edildi. Conflict yok.\n\n| | |\n|---|---|\n| **Upstream** | \`${{ env.UPSTREAM_REPO }}\` |\n| **Commits** | ${BEHIND_COUNT} yeni commit |\n| **Tarih** | $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC) |\n| **Tetikleyen** | \`${{ github.event_name }}\` |\n| **Durum** | âœ… Clean merge â€” conflict yok |\n\nDeÄŸiÅŸiklikleri inceleyip uygunsa merge edin.\n\n---\n_Bu PR otomatik olarak GitHub Actions tarafÄ±ndan oluÅŸturulmuÅŸtur._"

          # REST API ile PR oluÅŸtur
          PR_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/pulls" \
            -d "$(jq -n \
              --arg title "$PR_TITLE" \
              --arg body "$PR_BODY" \
              --arg head "$BRANCH_NAME" \
              --arg base "${{ env.TARGET_BRANCH }}" \
              '{title: $title, body: $body, head: $head, base: $base}')")

          PR_NUMBER=$(echo "$PR_RESPONSE" | jq -r '.number')
          PR_URL=$(echo "$PR_RESPONSE" | jq -r '.html_url')

          if [ "$PR_NUMBER" = "null" ] || [ -z "$PR_NUMBER" ]; then
            echo "âŒ PR creation failed:"
            echo "$PR_RESPONSE" | jq '.'
            exit 1
          fi

          echo "PR #${PR_NUMBER} created: $PR_URL"

          # Label'larÄ± ekle
          curl -s -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${PR_NUMBER}/labels" \
            -d '{"labels":["auto-sync","ready-to-merge"]}' > /dev/null || true

          echo "âœ… Clean sync PR created â€” ready for review."

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 9. Conflict â†’ PR oluÅŸtur (Ã§Ã¶zÃ¼m iÃ§in)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create conflict PR
        if: steps.merge.outputs.merge_status == 'conflict'
        env:
          GH_TOKEN: ${{ secrets.SYNC_PAT }}
        run: |
          CONFLICTED_FILES="${{ steps.merge.outputs.conflicted_files }}"
          BRANCH_NAME="${{ steps.merge.outputs.branch_name }}"
          BEHIND_COUNT="${{ steps.check.outputs.behind_count }}"

          FILE_LIST=$(echo "$CONFLICTED_FILES" | tr ',' '\n' | sed 's/^/- `/' | sed 's/$/`/')

          PR_TITLE="âš ï¸ Upstream Sync Conflict â€” Manuel Ã‡Ã¶zÃ¼m Gerekli"
          PR_BODY="## âš ï¸ Upstream Sync Conflict\n\nConflict tespit edildi.\n\n| | |\n|---|---|\n| **Upstream** | \`${{ env.UPSTREAM_REPO }}\` |\n| **Behind** | ${BEHIND_COUNT} commit |\n| **Tarih** | $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC) |\n\n### Conflict DosyalarÄ±\n\n${FILE_LIST}\n\n### Ã‡Ã¶zÃ¼m\n\n\`\`\`bash\ngit fetch origin\ngit checkout ${BRANCH_NAME}\n# Conflict'leri Ã§Ã¶zÃ¼n\ngit add <resolved-files>\ngit commit -m \"fix: resolve upstream sync conflicts\"\ngit push\n\`\`\`\n\n---\n_Bu PR otomatik olarak GitHub Actions tarafÄ±ndan oluÅŸturulmuÅŸtur._"

          # REST API ile PR oluÅŸtur
          PR_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/pulls" \
            -d "$(jq -n \
              --arg title "$PR_TITLE" \
              --arg body "$PR_BODY" \
              --arg head "$BRANCH_NAME" \
              --arg base "${{ env.TARGET_BRANCH }}" \
              '{title: $title, body: $body, head: $head, base: $base}')")

          PR_NUMBER=$(echo "$PR_RESPONSE" | jq -r '.number')
          PR_URL=$(echo "$PR_RESPONSE" | jq -r '.html_url')

          if [ "$PR_NUMBER" = "null" ] || [ -z "$PR_NUMBER" ]; then
            echo "âŒ PR creation failed:"
            echo "$PR_RESPONSE" | jq '.'
            exit 1
          fi

          echo "PR #${PR_NUMBER} created: $PR_URL"

          # Label'larÄ± ekle
          curl -s -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${PR_NUMBER}/labels" \
            -d '{"labels":["auto-sync","conflict"]}' > /dev/null || true

          echo "âœ… Conflict PR created â€” manual resolution needed."

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 10. Slack bildirim (opsiyonel)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Notify Slack (optional)
        if: steps.merge.outputs.merge_status == 'conflict' && env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -s -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"text\": \"âš ï¸ *Upstream Sync Conflict*\",
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"âš ï¸ Upstream Sync Conflict\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {\"type\": \"mrkdwn\", \"text\": \"*Repo:*\n${{ github.repository }}\"},
                    {\"type\": \"mrkdwn\", \"text\": \"*Files:*\n${{ steps.merge.outputs.conflicted_files }}\"}
                  ]
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"<${{ github.server_url }}/${{ github.repository }}/pulls|View Pull Requests>\"
                  }
                }
              ]
            }"
          echo "âœ… Slack notification sent."

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 11. Ã–zet
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Summary
        if: always()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Upstream Sync Summary"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          if [ "${{ steps.check.outputs.has_changes }}" = "false" ]; then
            echo "  Status: âœ… Already up to date"
          elif [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "  Status: ğŸ§ª Dry run completed"
          elif [ "${{ steps.merge.outputs.merge_status }}" = "clean" ]; then
            echo "  Status: âœ… Clean sync PR created"
            echo "  Branch: ${{ steps.merge.outputs.branch_name }}"
            echo "  Commits: ${{ steps.check.outputs.behind_count }}"
            echo "  Action: Review and merge the PR"
          elif [ "${{ steps.merge.outputs.merge_status }}" = "conflict" ]; then
            echo "  Status: âš ï¸ Conflict PR created"
            echo "  Branch: ${{ steps.merge.outputs.branch_name }}"
            echo "  Files:  ${{ steps.merge.outputs.conflicted_files }}"
            echo "  Action: Resolve conflicts and merge the PR"
          else
            echo "  Status: â­ï¸ Skipped"
          fi

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
