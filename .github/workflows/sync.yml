name: Sync with Parent

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Triggers:
#   1. Cron: Saatte bir upstream kontrolÃ¼
#   2. repository_dispatch: Parent push yaptÄ±ÄŸÄ±nda
#   3. workflow_dispatch: Manuel tetikleme
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  schedule:
    - cron: "0 * * * *"  # Her saat baÅŸÄ±

  repository_dispatch:
    types: [upstream-sync]

  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run â€” merge etme, sadece kontrol et"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

env:
  UPSTREAM_REPO: "https://github.com/Giorino/sync-parent.git"
  UPSTREAM_BRANCH: "main"
  TARGET_BRANCH: "main"

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    name: Sync upstream changes
    runs-on: ubuntu-latest

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1. Checkout â€” full history gerekli
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.SYNC_PAT }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2. Git identity ayarla
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3. Upstream remote ekle ve fetch et
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Add upstream remote
        run: |
          git remote add upstream "${{ env.UPSTREAM_REPO }}" 2>/dev/null || true
          git fetch upstream
          echo ""
          echo "ğŸ“Š Upstream status:"
          echo "  Local HEAD:    $(git rev-parse HEAD)"
          echo "  Upstream HEAD: $(git rev-parse upstream/${{ env.UPSTREAM_BRANCH }})"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4. DeÄŸiÅŸiklik var mÄ± kontrol et
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Check for changes
        id: check
        run: |
          LOCAL_SHA=$(git rev-parse HEAD)
          UPSTREAM_SHA=$(git rev-parse upstream/${{ env.UPSTREAM_BRANCH }})

          if [ "$LOCAL_SHA" = "$UPSTREAM_SHA" ]; then
            echo "âœ… Already up to date â€” nothing to sync."
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            BEHIND=$(git rev-list --count HEAD..upstream/${{ env.UPSTREAM_BRANCH }})
            echo "ğŸ”„ $BEHIND commit(s) behind upstream."
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "behind_count=$BEHIND" >> $GITHUB_OUTPUT
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 5. Dry run modu (sadece kontrol)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Dry run check
        if: steps.check.outputs.has_changes == 'true' && github.event.inputs.dry_run == 'true'
        run: |
          echo "ğŸ§ª DRY RUN â€” Merge simÃ¼lasyonu:"
          if git merge --no-commit --no-ff --allow-unrelated-histories upstream/${{ env.UPSTREAM_BRANCH }} 2>/dev/null; then
            echo "  âœ… Clean merge mÃ¼mkÃ¼n"
            git merge --abort 2>/dev/null || true
          else
            echo "  âš ï¸  Conflict tespit edildi!"
            git merge --abort 2>/dev/null || true
            echo ""
            echo "Conflict'li dosyalar:"
            git diff --name-only --diff-filter=U 2>/dev/null || true
          fi
          echo ""
          echo "â„¹ï¸  Dry run tamamlandÄ± â€” deÄŸiÅŸiklik uygulanmadÄ±."

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 6. Merge dene
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Attempt merge
        id: merge
        if: steps.check.outputs.has_changes == 'true' && github.event.inputs.dry_run != 'true'
        run: |
          echo "ğŸ”€ Merging upstream/${{ env.UPSTREAM_BRANCH }} into ${{ env.TARGET_BRANCH }}..."

          if git merge upstream/${{ env.UPSTREAM_BRANCH }} \
              --no-edit \
              --allow-unrelated-histories \
              -m "chore: sync with upstream ($(date -u +%Y-%m-%dT%H:%M:%SZ))"; then
            echo ""
            echo "âœ… Merge successful â€” no conflicts."
            echo "merge_status=success" >> $GITHUB_OUTPUT
          else
            echo ""
            echo "âŒ Merge failed â€” conflicts detected!"
            echo "merge_status=conflict" >> $GITHUB_OUTPUT

            # Conflict'li dosyalarÄ± kaydet
            CONFLICTED_FILES=$(git diff --name-only --diff-filter=U | tr '\n' ',' | sed 's/,$//')
            echo "conflicted_files=$CONFLICTED_FILES" >> $GITHUB_OUTPUT
            echo ""
            echo "Conflicted files: $CONFLICTED_FILES"

            # Merge'i geri al
            git merge --abort 2>/dev/null || true
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 7. BaÅŸarÄ±lÄ± merge â†’ Push
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Push changes
        if: steps.merge.outputs.merge_status == 'success'
        run: |
          echo "ğŸš€ Pushing merged changes to origin/${{ env.TARGET_BRANCH }}..."
          git push origin ${{ env.TARGET_BRANCH }}
          echo "âœ… Push complete."

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 8. Conflict â†’ PR branch oluÅŸtur
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create conflict branch
        id: conflict_branch
        if: steps.merge.outputs.merge_status == 'conflict'
        run: |
          TIMESTAMP=$(date -u +%Y%m%d-%H%M%S)
          BRANCH_NAME="upstream-sync/conflict-${TIMESTAMP}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          echo "ğŸŒ¿ Creating conflict branch: $BRANCH_NAME"
          git checkout -b "$BRANCH_NAME"

          # Merge'i conflict'li haliyle uygula (resolve etmeden)
          git merge upstream/${{ env.UPSTREAM_BRANCH }} --no-edit --allow-unrelated-histories || true

          # Conflict marker'lÄ± dosyalarÄ± commit et
          git add -A
          git commit -m "chore: upstream sync conflict (needs manual resolution)

          Conflicted files: ${{ steps.merge.outputs.conflicted_files }}

          This branch contains merge conflicts from upstream that need
          manual resolution. Please resolve the conflicts and merge this PR." || true

          git push https://x-access-token:${{ secrets.SYNC_PAT }}@github.com/${{ github.repository }}.git "$BRANCH_NAME"
          echo "âœ… Conflict branch pushed."

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 9. Conflict â†’ PR oluÅŸtur
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create Pull Request
        if: steps.merge.outputs.merge_status == 'conflict'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CONFLICTED_FILES="${{ steps.merge.outputs.conflicted_files }}"
          BRANCH_NAME="${{ steps.conflict_branch.outputs.branch_name }}"
          BEHIND_COUNT="${{ steps.check.outputs.behind_count }}"

          # Dosya listesini markdown formatÄ±na Ã§evir
          FILE_LIST=$(echo "$CONFLICTED_FILES" | tr ',' '\n' | sed 's/^/- `/' | sed 's/$/`/')

          PR_BODY="## âš ï¸ Upstream Sync Conflict

          Upstream repository'den gelen deÄŸiÅŸiklikler ile bu repository arasÄ±nda conflict tespit edildi.

          ### ğŸ“Š Detaylar

          | | |
          |---|---|
          | **Upstream** | \`${{ env.UPSTREAM_REPO }}\` |
          | **Behind** | ${BEHIND_COUNT} commit |
          | **Tarih** | $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC) |
          | **Tetikleyen** | \`${{ github.event_name }}\` |

          ### ğŸ“ Conflict'li Dosyalar

          ${FILE_LIST}

          ### ğŸ”§ Ã‡Ã¶zÃ¼m AdÄ±mlarÄ±

          1. Bu branch'i local'e Ã§ekin:
             \`\`\`bash
             git fetch origin
             git checkout ${BRANCH_NAME}
             \`\`\`

          2. Conflict'leri Ã§Ã¶zÃ¼n:
             \`\`\`bash
             # Her conflict'li dosyayÄ± dÃ¼zenleyin
             # <<<<<<< HEAD ve >>>>>>> upstream/main marker'larÄ±nÄ± kaldÄ±rÄ±n
             git add <resolved-files>
             git commit -m \"fix: resolve upstream sync conflicts\"
             \`\`\`

          3. PR'Ä± merge edin.

          ---
          _Bu PR otomatik olarak GitHub Actions tarafÄ±ndan oluÅŸturulmuÅŸtur._"

          gh pr create \
            --base "${{ env.TARGET_BRANCH }}" \
            --head "$BRANCH_NAME" \
            --title "âš ï¸ Upstream Sync Conflict â€” Manuel Ã‡Ã¶zÃ¼m Gerekli" \
            --body "$PR_BODY" \
            --label "auto-sync,conflict"

          echo "âœ… Pull Request created."

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 10. Label'larÄ± oluÅŸtur (yoksa)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Ensure labels exist
        if: steps.merge.outputs.merge_status == 'conflict'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Label yoksa oluÅŸtur, varsa atla
          gh label create "auto-sync" \
            --description "Automatically created by upstream sync" \
            --color "0E8A16" 2>/dev/null || true

          gh label create "conflict" \
            --description "Merge conflict needs manual resolution" \
            --color "D93F0B" 2>/dev/null || true

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 11. Slack bildirim (opsiyonel)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Notify Slack (optional)
        if: steps.merge.outputs.merge_status == 'conflict' && env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -s -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"text\": \"âš ï¸ *Upstream Sync Conflict*\",
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"âš ï¸ Upstream Sync Conflict\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {\"type\": \"mrkdwn\", \"text\": \"*Repo:*\n${{ github.repository }}\"},
                    {\"type\": \"mrkdwn\", \"text\": \"*Files:*\n${{ steps.merge.outputs.conflicted_files }}\"}
                  ]
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"<${{ github.server_url }}/${{ github.repository }}/pulls|View Pull Requests>\"
                  }
                }
              ]
            }"
          echo "âœ… Slack notification sent."

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 12. Conflict varsa action'Ä± fail et
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Fail on conflict
        if: steps.merge.outputs.merge_status == 'conflict'
        run: |
          echo "âŒ Action failed due to merge conflicts."
          echo "   A Pull Request has been created for manual resolution."
          exit 1

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 13. Ã–zet
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Summary
        if: always()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Upstream Sync Summary"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          if [ "${{ steps.check.outputs.has_changes }}" = "false" ]; then
            echo "  Status: âœ… Already up to date"
          elif [ "${{ steps.merge.outputs.merge_status }}" = "success" ]; then
            echo "  Status: âœ… Synced successfully"
            echo "  Commits: ${{ steps.check.outputs.behind_count }} merged"
          elif [ "${{ steps.merge.outputs.merge_status }}" = "conflict" ]; then
            echo "  Status: âŒ Conflict detected"
            echo "  Files:  ${{ steps.merge.outputs.conflicted_files }}"
            echo "  PR:     Created for manual resolution"
          else
            echo "  Status: â­ï¸  Skipped (dry run or no changes)"
          fi

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
